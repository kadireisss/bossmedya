<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Bossmedya Ziyaretçi Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, Arial, sans-serif; background:#020617; color:#e5e7eb; margin:0; padding:20px; }
    h1, h2 { color:#f97316; margin-top:0; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; }
    .card { background:#020617; border-radius:16px; padding:16px 18px; box-shadow:0 20px 40px rgba(15,23,42,0.9); border:1px solid #1f2937; }
    .badge { display:inline-block; padding:3px 8px; border-radius:999px; background:#1f2937; font-size:11px; color:#9ca3af; }
    .big { font-size:32px; font-weight:700; margin:10px 0; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:6px 8px; border-bottom:1px solid #1f2937; text-align:left; }
    th { color:#9ca3af; font-weight:500; background:#020617; position:sticky; top:0; }
    .code { font-family:monospace; font-size:12px; word-break:break-all; }
    .sub { color:#9ca3af; font-size:12px; }
  </style>
</head>
<body>
  <h1>Bossmedya Canlı Ziyaretçi Paneli</h1>
  <p class="sub">URL'nin sonuna <strong>?key=ADMIN_KEY</strong> eklemeyi unutma.</p>

  <div id="error" style="display:none; padding:10px 12px; border-radius:8px; background:#7f1d1d; margin-bottom:15px;"></div>

  <div class="grid">
    <div class="card">
      <h2>Şu an online</h2>
      <div class="big" id="onlineCount">-</div>
    </div>
    <div class="card">
      <h2>Toplam oturum</h2>
      <div class="big" id="totalSessions">-</div>
    </div>
  </div>

  <div class="grid" style="margin-top:20px;">
    <div class="card">
      <h2>Cihaz Dağılımı</h2>
      <canvas id="deviceChart" height="130"></canvas>
    </div>
    <div class="card">
      <h2>Ülkelere Göre</h2>
      <canvas id="countryChart" height="130"></canvas>
    </div>
    <div class="card">
      <h2>En Çok Trafik Getiren Sayfalar</h2>
      <table id="pageTable">
        <tr><th>Sayfa</th><th>Oturum</th></tr>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:20px;">
    <h2>Canlı Oturumlar</h2>
    <div style="max-height:300px; overflow:auto;">
      <table id="liveTable">
        <tr>
          <th>IP</th>
          <th>Ülke</th>
          <th>Cihaz</th>
          <th>Sayfa</th>
          <th>Referrer</th>
          <th>Son Görülme</th>
        </tr>
      </table>
    </div>
  </div>

<script>
(function(){
  function escapeHtml(str){return (str||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

  const params = new URLSearchParams(window.location.search);
  const key = params.get('key') || '';
  if (!key) {
    const e = document.getElementById('error');
    e.style.display = 'block';
    e.innerText = 'Admin anahtarı (?key=...) belirtilmedi.';
    return;
  }

  fetch('/api/stats?key=' + encodeURIComponent(key))
    .then(r => r.json())
    .then(d => {
      if (d.error) {
        const e = document.getElementById('error');
        e.style.display = 'block';
        e.innerText = 'Hata: ' + d.error;
        return;
      }
      render(d);
    })
    .catch(err => {
      const e = document.getElementById('error');
      e.style.display = 'block';
      e.innerText = 'İstek hatası: ' + err;
    });

  function render(d){
    document.getElementById('onlineCount').innerText = d.online;
    document.getElementById('totalSessions').innerText = d.totalSessions;

    const deviceCtx = document.getElementById('deviceChart').getContext('2d');
    new Chart(deviceCtx, {
      type: 'doughnut',
      data: {
        labels: d.topDevices.map(x => x.name),
        datasets: [{ data: d.topDevices.map(x => x.count), borderWidth:1 }]
      },
      options: { plugins:{ legend:{ labels:{ color:'#e5e7eb' } } } }
    });

    const countryCtx = document.getElementById('countryChart').getContext('2d');
    new Chart(countryCtx, {
      type: 'bar',
      data: {
        labels: d.topCountries.map(x => x.name),
        datasets: [{ data: d.topCountries.map(x => x.count), borderWidth:1 }]
      },
      options: {
        plugins:{ legend:{ display:false } },
        scales:{
          x:{ ticks:{color:'#9ca3af'}, grid:{display:false} },
          y:{ ticks:{color:'#9ca3af'}, grid:{color:'rgba(31,41,55,0.6)'} }
        }
      }
    });

    const pageTable = document.getElementById('pageTable');
    d.topPages.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td class="code">'+escapeHtml(p.name)+'</td><td>'+p.count+'</td>';
      pageTable.appendChild(tr);
    });

    const liveTable = document.getElementById('liveTable');
    d.latestSessions.forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML =
        '<td class="code">'+escapeHtml(s.ip)+'</td>'+
        '<td>'+escapeHtml(s.country)+'</td>'+
        '<td>'+escapeHtml(s.device)+'</td>'+
        '<td class="code">'+escapeHtml(s.page)+'</td>'+
        '<td class="code">'+escapeHtml(s.ref)+'</td>'+
        '<td>'+new Date(s.last_seen).toLocaleString()+'</td>';
      liveTable.appendChild(tr);
    });
  }
})();
</script>
</body>
</html>
